//
//  CRTC.swift
//  SwarmEmu
//
//  Created by Antonio Sanchez-Rivas on 6/4/2024.
//

import Foundation
import SwiftUI

class CRTC : ObservableObject {
    
    var pcg = Array<UInt8>(repeating: 0,count:4096)
    var screen = Array<UInt8>(repeating: 32,count:4096)
    
    var xzoom : Int = 1
    var yzoom : Int = 2
    
    @Published var screenbitmap = Array<Bool>(repeating: false,count:131072)
    
    func ClearScreen()
    {
        for MyIndex in 0..<131072
        {
            screenbitmap[MyIndex] = false
        }
    }
    
   init ()
    
    {
        let charrom : String = """
        0000 0000 7f41 4141 4141 4141 7f00 0000
        0000 0000 7f40 4040 4040 4040 4000 0000
        0000 0000 0808 0808 0808 0808 7f00 0000
        0000 0000 0101 0101 0101 0101 7f00 0000
        0000 0000 2010 0804 3e10 0804 0200 0000
        0000 0000 7f41 6355 4955 6341 7f00 0000
        0000 0000 0001 0204 4850 6040 0000 0000
        0000 0000 1c22 4141 417f 1414 7700 0000
        0000 0000 1020 7c22 1101 0101 0100 0000
        0000 0000 0008 0402 7f02 0408 0000 0000
        0000 0000 7f00 0000 7f00 0000 7f00 0000
        0000 0000 0008 0808 492a 1c08 0000 0000
        0000 0000 0808 2a1c 0849 2a1c 0800 0000
        0000 0000 0008 1020 7f20 1008 0000 0000
        0000 0000 1c22 6355 4955 6322 1c00 0000
        0000 0000 1c22 4141 4941 4122 1c00 0000
        0000 0000 7f41 4141 7f41 4141 7f00 0000
        0000 0000 1c2a 4949 4f41 4122 1c00 0000
        0000 0000 1c22 4141 4f49 492a 1c00 0000
        0000 0000 1c22 4141 7949 492a 1c00 0000
        0000 0000 1c2a 4949 7941 4122 1c00 0000
        0000 0000 0011 0a04 4a51 6040 0000 0000
        0000 0000 3e22 2222 2222 2222 6300 0000
        0000 0000 0101 0101 7f01 0101 0100 0000
        0000 0000 7f41 2214 0814 2241 7f00 0000
        0000 0000 0808 081c 1c08 0808 0800 0000
        0000 0000 3c42 4240 3008 0800 0800 0000
        0000 0000 1c22 4141 7f41 4122 1c00 0000
        0000 0000 7f49 4949 7941 4141 7f00 0000
        0000 0000 7f41 4141 7949 4949 7f00 0000
        0000 0000 7f41 4141 4f49 4949 7f00 0000
        0000 0000 7f49 4949 4f41 4141 7f00 0000
        0000 0000 0000 0000 0000 0000 0000 0000
        0000 0000 0808 0808 0800 0008 0800 0000
        0000 0000 2424 2400 0000 0000 0000 0000
        0000 0000 1414 147f 147f 1414 1400 0000
        0000 0000 083f 4848 3e09 097e 0800 0000
        0000 0000 2051 2204 0810 2245 0200 0000
        0000 0000 3844 4428 1029 4646 3900 0000
        0000 0000 0c0c 0810 0000 0000 0000 0000
        0000 0000 0408 1010 1010 1008 0400 0000
        0000 0000 1008 0404 0404 0408 1000 0000
        0000 0000 0008 492a 1c2a 4908 0000 0000
        0000 0000 0008 0808 7f08 0808 0000 0000
        0000 0000 0000 0000 0000 0018 1810 2000
        0000 0000 0000 0000 7f00 0000 0000 0000
        0000 0000 0000 0000 0000 0018 1800 0000
        0000 0000 0001 0204 0810 2040 0000 0000
        0000 0000 3e41 4345 4951 6141 3e00 0000
        0000 0000 0818 2808 0808 0808 3e00 0000
        0000 0000 3e41 0102 1c20 4040 7f00 0000
        0000 0000 3e41 0101 1e01 0141 3e00 0000
        0000 0000 0206 0a12 2242 7f02 0200 0000
        0000 0000 7f40 407c 0201 0142 3c00 0000
        0000 0000 1e20 4040 7e41 4141 3e00 0000
        0000 0000 7f41 0204 0810 1010 1000 0000
        0000 0000 3e41 4141 3e41 4141 3e00 0000
        0000 0000 3e41 4141 3f01 0102 3c00 0000
        0000 0000 0000 0018 1800 0018 1800 0000
        0000 0000 0000 0018 1800 0018 1810 2000
        0000 0000 0408 1020 4020 1008 0400 0000
        0000 0000 0000 003e 003e 0000 0000 0000
        0000 0000 1008 0402 0102 0408 1000 0000
        0000 0000 1e21 2101 0608 0800 0800 0000
        0000 0000 1e21 4d55 555e 4020 1e00 0000
        0000 0000 1c22 4141 417f 4141 4100 0000
        0000 0000 7e21 2121 3e21 2121 7e00 0000
        0000 0000 1e21 4040 4040 4021 1e00 0000
        0000 0000 7c22 2121 2121 2122 7c00 0000
        0000 0000 7f40 4040 7840 4040 7f00 0000
        0000 0000 7f40 4040 7840 4040 4000 0000
        0000 0000 1e21 4040 404f 4121 1e00 0000
        0000 0000 4141 4141 7f41 4141 4100 0000
        0000 0000 3e08 0808 0808 0808 3e00 0000
        0000 0000 1f04 0404 0404 0444 3800 0000
        0000 0000 4142 4448 5068 4442 4100 0000
        0000 0000 4040 4040 4040 4040 7f00 0000
        0000 0000 4163 5549 4941 4141 4100 0000
        0000 0000 4161 5149 4543 4141 4100 0000
        0000 0000 1c22 4141 4141 4122 1c00 0000
        0000 0000 7e41 4141 7e40 4040 4000 0000
        0000 0000 1c22 4141 4149 4522 1d00 0000
        0000 0000 7e41 4141 7e48 4442 4100 0000
        0000 0000 3e41 4040 3e01 0141 3e00 0000
        0000 0000 7f08 0808 0808 0808 0800 0000
        0000 0000 4141 4141 4141 4141 3e00 0000
        0000 0000 4141 4122 2214 1408 0800 0000
        0000 0000 4141 4141 4949 5563 4100 0000
        0000 0000 4141 2214 0814 2241 4100 0000
        0000 0000 4141 2214 0808 0808 0800 0000
        0000 0000 7f01 0204 0810 2040 7f00 0000
        0000 0000 3c20 2020 2020 2020 3c00 0000
        0000 0000 0040 2010 0804 0201 0000 0000
        0000 0000 3c04 0404 0404 0404 3c00 0000
        0000 0000 0814 2241 0000 0000 0000 0000
        0000 0000 0000 0000 0000 0000 7f00 0000
        0000 0000 1818 0804 0000 0000 0000 0000
        0000 0000 0000 003c 023e 4242 3d00 0000
        0000 0000 4040 405c 6242 4262 5c00 0000
        0000 0000 0000 003c 4240 4042 3c00 0000
        0000 0000 0202 023a 4642 4246 3a00 0000
        0000 0000 0000 003c 427e 4040 3c00 0000
        0000 0000 0c12 1010 7c10 1010 1000 0000
        0000 0000 0000 003a 4642 463a 0202 423c
        0000 0000 4040 405c 6242 4242 4200 0000
        0000 0000 0008 0018 0808 0808 1c00 0000
        0000 0000 0002 0006 0202 0202 0202 221c
        0000 0000 4040 4044 4850 6844 4200 0000
        0000 0000 1808 0808 0808 0808 1c00 0000
        0000 0000 0000 0076 4949 4949 4900 0000
        0000 0000 0000 005c 6242 4242 4200 0000
        0000 0000 0000 003c 4242 4242 3c00 0000
        0000 0000 0000 005c 6242 4262 5c40 4040
        0000 0000 0000 003a 4642 4246 3a02 0202
        0000 0000 0000 005c 6240 4040 4000 0000
        0000 0000 0000 003c 4230 0c42 3c00 0000
        0000 0000 0010 107c 1010 1012 0c00 0000
        0000 0000 0000 0042 4242 4246 3a00 0000
        0000 0000 0000 0041 4141 2214 0800 0000
        0000 0000 0000 0041 4949 4949 3600 0000
        0000 0000 0000 0042 2418 1824 4200 0000
        0000 0000 0000 0042 4242 4246 3a02 423c
        0000 0000 0000 007e 0408 1020 7e00 0000
        0000 0000 0c10 1010 2010 1010 0c00 0000
        0000 0000 0808 0800 0008 0808 0000 0000
        0000 0000 1804 0404 0204 0404 1800 0000
        0000 0000 3049 0600 0000 0000 0000 0000
        0000 0000 2449 1224 4912 2449 1200 0000
        0000 3e22 2222 2222 3e00 0000 0000 0000
        0000 3e20 2020 2020 2000 0000 0000 0000
        0000 0808 0808 0808 3e00 0000 0000 0000
        0000 0202 0202 0202 3e00 0000 0000 0000
        0000 1008 041e 0804 0200 0000 0000 0000
        0000 3e22 362a 3622 3e00 0000 0000 0000
        0000 0002 0428 3020 0000 0000 0000 0000
        0000 1c22 223e 1414 3600 0000 0000 0000
        0000 0810 3c12 0a02 0200 0000 0000 0000
        0000 0008 043e 0408 0000 0000 0000 0000
        0000 3e00 003e 0000 3e00 0000 0000 0000
        0000 0008 082a 1c08 0000 0000 0000 0000
        0000 082a 1c08 2a1c 0800 0000 0000 0000
        0000 0008 103e 1008 0000 0000 0000 0000
        0000 1c22 362a 3622 1c00 0000 0000 0000
        0000 1c22 222a 2222 1c00 0000 0000 0000
        0000 3e22 223e 2222 3e00 0000 0000 0000
        0000 1c2a 2a2e 2222 1c00 0000 0000 0000
        0000 1c22 222e 2a2a 1c00 0000 0000 0000
        0000 1c22 223a 2a2a 1c00 0000 0000 0000
        0000 1c2a 2a3a 2222 1c00 0000 0000 0000
        0000 000a 042a 3020 0000 0000 0000 0000
        0000 1c14 1414 1414 3600 0000 0000 0000
        0000 0202 023e 0202 0200 0000 0000 0000
        0000 3e22 1408 1422 3e00 0000 0000 0000
        0000 0808 1c1c 0808 0800 0000 0000 0000
        0000 1c22 2010 0800 0800 0000 0000 0000
        0000 1c22 223e 2222 1c00 0000 0000 0000
        0000 3e2a 2a3a 2222 3e00 0000 0000 0000
        0000 3e22 223a 2a2a 3e00 0000 0000 0000
        0000 3e22 222e 2a2a 3e00 0000 0000 0000
        0000 3e2a 2a2e 2222 3e00 0000 0000 0000
        0000 0000 0000 0000 0000 0000 0000 0000
        0000 0808 0808 0800 0800 0000 0000 0000
        0000 1414 1400 0000 0000 0000 0000 0000
        0000 1414 3e14 3e14 1400 0000 0000 0000
        0000 081e 281c 0a3c 0800 0000 0000 0000
        0000 3032 0408 1026 0600 0000 0000 0000
        0000 1028 2810 2a24 1a00 0000 0000 0000
        0000 1818 1020 0000 0000 0000 0000 0000
        0000 0408 1010 1008 0400 0000 0000 0000
        0000 1008 0404 0408 1000 0000 0000 0000
        0000 082a 1c3e 1c2a 0800 0000 0000 0000
        0000 0008 083e 0808 0000 0000 0000 0000
        0000 0000 0000 1818 1020 0000 0000 0000
        0000 0000 003e 0000 0000 0000 0000 0000
        0000 0000 0000 0018 1800 0000 0000 0000
        0000 0002 0408 1020 0000 0000 0000 0000
        0000 1c22 262a 3222 1c00 0000 0000 0000
        0000 0818 0808 0808 1c00 0000 0000 0000
        0000 1c22 021c 2020 3e00 0000 0000 0000
        0000 1c22 020c 0222 1c00 0000 0000 0000
        0000 040c 1424 3e04 0400 0000 0000 0000
        0000 3e20 1c02 0222 1c00 0000 0000 0000
        0000 0c10 203c 2222 1c00 0000 0000 0000
        0000 3e02 0408 1020 2000 0000 0000 0000
        0000 1c22 221c 2222 1c00 0000 0000 0000
        0000 1c22 221e 0204 1800 0000 0000 0000
        0000 0018 1800 1818 0000 0000 0000 0000
        0000 0018 1800 1818 1020 0000 0000 0000
        0000 0408 1020 1008 0400 0000 0000 0000
        0000 0000 3e00 3e00 0000 0000 0000 0000
        0000 1008 0402 0408 1000 0000 0000 0000
        0000 1c22 0204 0800 0800 0000 0000 0000
        0000 1c22 021a 2a2a 1c00 0000 0000 0000
        0000 0814 2222 3e22 2200 0000 0000 0000
        0000 3c12 121c 1212 3c00 0000 0000 0000
        0000 1c22 2020 2022 1c00 0000 0000 0000
        0000 3c12 1212 1212 3c00 0000 0000 0000
        0000 3e20 2038 2020 3e00 0000 0000 0000
        0000 3e20 2038 2020 2000 0000 0000 0000
        0000 1e20 2026 2222 1e00 0000 0000 0000
        0000 2222 223e 2222 2200 0000 0000 0000
        0000 1c08 0808 0808 1c00 0000 0000 0000
        0000 0202 0202 0222 1c00 0000 0000 0000
        0000 2224 2830 2824 2200 0000 0000 0000
        0000 2020 2020 2020 3e00 0000 0000 0000
        0000 2236 2a2a 2222 2200 0000 0000 0000
        0000 2232 2a26 2222 2200 0000 0000 0000
        0000 1c22 2222 2222 1c00 0000 0000 0000
        0000 3c22 223c 2020 2000 0000 0000 0000
        0000 1c22 2222 2a24 1a00 0000 0000 0000
        0000 3c22 223c 2824 2200 0000 0000 0000
        0000 1c22 201c 0222 1c00 0000 0000 0000
        0000 3e08 0808 0808 0800 0000 0000 0000
        0000 2222 2222 2222 1c00 0000 0000 0000
        0000 2222 2214 1408 0800 0000 0000 0000
        0000 2222 2222 2a36 2200 0000 0000 0000
        0000 2222 1408 1422 2200 0000 0000 0000
        0000 2222 1408 0808 0800 0000 0000 0000
        0000 3e02 0408 1020 3e00 0000 0000 0000
        0000 1c10 1010 1010 1c00 0000 0000 0000
        0000 0020 1008 0402 0000 0000 0000 0000
        0000 1c04 0404 0404 1c00 0000 0000 0000
        0000 0814 2200 0000 0000 0000 0000 0000
        0000 0000 0000 0000 3e00 0000 0000 0000
        0000 0c0c 0804 0000 0000 0000 0000 0000
        0000 0000 1c02 1e22 1e00 0000 0000 0000
        0000 2020 2c32 2232 2c00 0000 0000 0000
        0000 0000 1c22 2022 1c00 0000 0000 0000
        0000 0202 1a26 2226 1a00 0000 0000 0000
        0000 0000 1c22 3e20 1c00 0000 0000 0000
        0000 040a 081c 0808 0800 0000 0000 0000
        0000 0000 1a26 261a 0222 1c00 0000 0000
        0000 2020 2c32 2222 2200 0000 0000 0000
        0000 0800 1808 0808 1c00 0000 0000 0000
        0000 0002 0002 0202 0222 1c00 0000 0000
        0000 2020 2428 3028 2400 0000 0000 0000
        0000 1808 0808 0808 1c00 0000 0000 0000
        0000 0000 342a 2a2a 2a00 0000 0000 0000
        0000 0000 2c32 2222 2200 0000 0000 0000
        0000 0000 1c22 2222 1c00 0000 0000 0000
        0000 0000 2c32 2232 2c20 2000 0000 0000
        0000 0000 1a26 2226 1a02 0200 0000 0000
        0000 0000 2c32 2020 2000 0000 0000 0000
        0000 0000 1e20 1c02 3c00 0000 0000 0000
        0000 0808 3e08 080a 0400 0000 0000 0000
        0000 0000 2222 2226 1a00 0000 0000 0000
        0000 0000 2222 2214 0800 0000 0000 0000
        0000 0000 2222 2a2a 1400 0000 0000 0000
        0000 0000 2214 0814 2200 0000 0000 0000
        0000 0000 2222 221e 0222 1c00 0000 0000
        0000 0000 3e04 0810 3e00 0000 0000 0000
        0000 0408 0810 0808 0400 0000 0000 0000
        0000 0808 0800 0808 0800 0000 0000 0000
        0000 1008 0804 0808 1000 0000 0000 0000
        0000 102a 0400 0000 0000 0000 0000 0000
        0000 142a 142a 142a 1400 0000 0000 0000
    """
        var tempcharrom : String
        tempcharrom = charrom.replacingOccurrences(of: " ", with: "")
        tempcharrom = tempcharrom.replacingOccurrences(of: "\n", with: "")
        var pcgindex : Int = 0
        var startstring = tempcharrom.startIndex
        var endstring = tempcharrom.index(tempcharrom.startIndex,offsetBy:2)
        
        while startstring < tempcharrom.endIndex
        {
            //print(tempcharrom[startstring..<endstring])
            //print(Int(tempcharrom[startstring..<endstring],radix:16))
            pcg[pcgindex] = UInt8(tempcharrom[startstring..<endstring],radix:16) ?? 0
            pcgindex = pcgindex + 1
            startstring = endstring
            if startstring < tempcharrom.endIndex
            {
                endstring = tempcharrom.index(startstring,offsetBy:2)
            }
        }
        ClearScreen()
        printstring("SwarmEmu To-do list",0,0)
        printstring("* Emulate Z80",0,1)
        printstring("* Emulate CRTC",0,2)
        printstring("* Emulate Keyboard",0,3)
        printstring("* Emulate Sound",0,4)
        printstring("* Load Basic",0,5)
        printstring("* Run Games",0,6)
    }
    
    func printchar ( _ charo : Character, _ dxpos : Int, _ dypos : Int )
    
    {
        var startpos : Int
        
        var bit8 : Bool
        var bit7 : Bool
        var bit6 : Bool
        var bit5 : Bool
        var bit4 : Bool
        var bit3 : Bool
        var bit2 : Bool
        var bit1 : Bool
        
        startpos = Int(charo.asciiValue ?? 0)*16
        
        for MyIndex in 0...15
        {
            //print("**",MyIndex)
            bit8 = ((pcg[startpos+MyIndex] & 0b10000000) >> 7) == 1
            bit7 = ((pcg[startpos+MyIndex] & 0b01000000) >> 6) == 1
            bit6 = ((pcg[startpos+MyIndex] & 0b00100000) >> 5) == 1
            bit5 = ((pcg[startpos+MyIndex] & 0b00010000) >> 4) == 1
            bit4 = ((pcg[startpos+MyIndex] & 0b00001000) >> 3) == 1
            bit3 = ((pcg[startpos+MyIndex] & 0b00000100) >> 2) == 1
            bit2 = ((pcg[startpos+MyIndex] & 0b00000010) >> 1) == 1
            bit1 = ((pcg[startpos+MyIndex] & 0b00000001) >> 0) == 1
            
            //let stringy = String(pcg[startpos+MyIndex], radix: 2)
            //let padd = String(repeating: "0",count: (8 - stringy.count))
            //print(padd + stringy)
            
            if bit8 {
                screenbitmap[(dypos*512*16)+(MyIndex*512)+(dxpos*8)] = true
            }
            if bit7 {
                screenbitmap[(dypos*512*16)+(MyIndex*512)+(dxpos*8)+1] = true
                // print((ypos+MyIndex)*512+xpos+1)
            }
            if bit6 {
                screenbitmap[(dypos*512*16)+(MyIndex*512)+(dxpos*8)+2] = true
                // print((ypos+MyIndex)*512+xpos+2)
            }
            if bit5 {
                screenbitmap[(dypos*512*16)+(MyIndex*512)+(dxpos*8)+3] = true
                //print((ypos+MyIndex)*512+xpos+3)
            }
            if bit4 {
                screenbitmap[(dypos*512*16)+(MyIndex*512)+(dxpos*8)+4] = true
                // print((ypos+MyIndex)*512+xpos+4)
            }
            if bit3 {
                screenbitmap[(dypos*512*16)+(MyIndex*512)+(dxpos*8)+5] = true
                // print((ypos+MyIndex)*512+xpos+5)
            }
            if bit2 {
                screenbitmap[(dypos*512*16)+(MyIndex*512)+(dxpos*8)+6] = true
                //print((ypos+MyIndex)*512+xpos+6)
            }
            if bit1 {
                screenbitmap[(dypos*512*16)+(MyIndex*512)+(dxpos*8)+7] = true
                //print((ypos+MyIndex)*512+xpos+7)
            }
        }
    }

    func printstring( _ message : String, _ xpos : Int, _ ypos : Int )
    
    {
        
        var xposition : Int = 0
        
        for ascii in message
        {
          if xpos+xposition < 64
            {
              printchar(ascii,xpos+xposition,ypos)
              xposition = xposition+1
            }
        }
    }
}
